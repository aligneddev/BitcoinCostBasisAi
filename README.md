# Bitcoin Cost Basis AI Agent System

## Agents

- Bitcoin Cost Basis Orchestrator Agent
  - takes in rows of data as csv in a described F# type (date bought, date sold, amount bought, amount sold)
  - verifies type is matched
  - use BitcoinHistoricalPriceMcp to get historical prices and line them up with the transactions
  - calculate cost basis using FIFO method
  - calls the Bitcoin Tax Specialist Agent to get tax advice
  - reports suggestions on changes 
  - asks the user if they want to run the Fill form with Playwright Agent to fill in the tax form
  - calls the Verify filled form Agent to check the filled in form is correct
  - outputs the results to a file or console
  - asks the Bitcoin Tax Specialist Agent for things to do differently for the next year 

- Bitcoin Tax Specialist Agent
  - knows the Bitcoin tax rules and gives advice

- Fill form with Playwright Agent
  - structured input - JSON
  - optional agent
  - take the data and fill in the Capital Gains form (is this even possible? we shall see)
  - asks for confirmation before filling in the row
  - ask for verification after filling in the row
  - can it be generic or have to be specific to my tax software?

- Verify filled form Agent
  - check the filled in form is correct with the data given

### Other Miscellaneous Agents

Maybe I could make this a larger web of agents...
- Bitcoin Analyzer
  - how much have I increased in Sats/USD?
  - What if I sold now?
  - reporting over time with graphs based on transactions
- Bitcoin Maximalist Expert
  - not really needed ask questions, inspiration, longer term thinking
  - security suggestions
  - it doesn't add much value to Cost basis and taxes, but maybe it can add some commentary
  - complain that there shouldn't be taxes on Bitcoin transactions

## Workflows generated by Copilot

```mermaid
flowchart TD

    U(User) -->|Provide Tx CSV / Year| ORCH(Orchestrator) --> ValidateCSV[Validate CSV Format]
    ValidateCSV -->|Valid| PARSE[Parse & Normalize Transactions]
    ValidateCSV -->|Invalid| ERROR[Error: Prompt user]
    PARSE --> PRICE[BitcoinHistoricalPriceMcp]
    PRICE --> COSTBASIS[CostBasisAgent-FIFO]
    COSTBASIS --> TAX[TaxSpecialistAgent]
    TAX -->|Advice + Suggested Changes| USERDEC{User Confirms Form Filing?}
    USERDEC -- Yes --> FORM[FormFillerAgent]
    FORM --> VERIFY[FormVerificationAgent]
    VERIFY -->|Row OK| NEXT{More Rows?}
    NEXT -- Yes --> FORM
    NEXT -- No --> ANALYZER[BitcoinAnalyzerAgent-optional]
    ANALYZER --> SUMMARY[Summary & Next-Year Suggestions]
    USERDEC -- No --> SUMMARY
    VERIFY -->|Mismatch| REMEDIATE[Remediation Loop]
    REMEDIATE --> FORM
    SUMMARY --> OUT[(Persist Results + Reports)]
```

```mermaid
flowchart TD

    subgraph workflow_steps ["Simplified Workflow Steps"]
      direction TB
      LOADED(Loaded) --> PRICED(Priced)
      PRICED --> COSTBASISCOMPUTED(Cost Basis Computed)
      COSTBASISCOMPUTED --> TAXADVISED(Tax Advised)
      TAXADVISED -->|User Approves| FORMFF(Form Filling)
      FORMFF --> VERIFYFF(Verification)
      VERIFYFF --> COMPLETED(Completed)
      TAXADVISED -->|User Rejects| ADJUSTMENTS(Adjustments)
      ADJUSTMENTS -->|Back to Compute| COSTBASISCOMPUTED
      ADJUSTMENTS -->|Back to Advice| TAXADVISED
    end
```

### Lifecycle

```
Loaded -> Priced -> CostBasisComputed -> TaxAdvised
 -> (If user approves) FormFilling -> Verification -> Completed
 -> (If reject) Adjustments (back to CostBasisComputed or TaxAdvised)
```

### 

```mermaid
sequenceDiagram
    participant User
    participant Orchestrator
    participant Price as PricePlugin
    participant Cost as CostBasisAgent
    participant Tax as TaxSpecialistAgent
    participant Form as FormFillerAgent
    participant Verify as FormVerificationAgent

    User->>Orchestrator: Upload CSV
    Orchestrator->>Price: BulkGetPrices(dates)
    Price-->>Orchestrator: Enriched price map
    Orchestrator->>Cost: transactions + prices
    Cost-->>Orchestrator: FIFO lots + gains JSON
    Orchestrator->>Tax: gains JSON
    Tax-->>Orchestrator: Tax advice + recommendations
    Orchestrator->>User: Show advice + ask to file
    User-->>Orchestrator: Approve
    loop Each row
        Orchestrator->>Form: FillRow(row data)
        Form-->>Orchestrator: RowFilled(rowId)
        Orchestrator->>Verify: VerifyRow(rowId, expected)
        alt Row valid
            Verify-->>Orchestrator: OK
        else Row mismatch
            Verify-->>Orchestrator: Diff report
            Orchestrator->>Form: CorrectRow(rowId, patch)
        end
    end
    Orchestrator->>User: Completion summary + next-year tips
```
